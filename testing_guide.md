# 🧪 Руководство по тестированию интеграции FreePBX 17 + AmoCRM

## Подготовка к тестированию

### 1. Включите режим отладки

Отредактируйте `/opt/freepbx-amocrm/config.json`:

```json
{
  "debug": {
    "process_internal_calls": true,
    "test_phone": "79991234567",
    "detailed_ami_logging": true
  }
}
```

**Где:**
- `process_internal_calls: true` - обрабатывать внутренние звонки (101→102)
- `test_phone` - реальный номер из AmoCRM для тестирования
- `detailed_ami_logging: true` - подробные логи событий AMI

Перезапустите сервис:
```bash
systemctl restart freepbx-amocrm
```

### 2. Добавьте тестовый контакт в AmoCRM

1. Зайдите в AmoCRM
2. Создайте контакт с номером `+7 999 123-45-67`
3. Сохраните

## Методы тестирования

### 🎯 Метод 1: Тестовый endpoint (САМЫЙ ПРОСТОЙ)

Используйте встроенный тестовый endpoint:

```bash
# Отправляем тестовый звонок
curl http://localhost:8080/test-call

# Ожидаемый ответ:
{
  "success": true,
  "message": "Тестовый звонок обработан для номера 79991234567",
  "call_data": {
    "phone": "79991234567",
    "direction": "inbound",
    "duration": 42,
    "status": "ANSWERED"
  }
}
```

**Проверка:**
1. Посмотрите логи: `journalctl -u freepbx-amocrm -n 50`
2. Зайдите в AmoCRM → найдите контакт → должен появиться звонок

---

### 🎯 Метод 2: Внутренний звонок (С ОТЛАДКОЙ)

При включенном `process_internal_calls: true`:

```bash
# 1. Следите за логами
journalctl -u freepbx-amocrm -f

# 2. Сделайте внутренний звонок
# С телефона 101 позвоните на 102
# Поговорите ~30 секунд
# Положите трубку

# 3. В логах увидите:
# ╔══════════════════════════════════════
# ║ НОВЫЙ КАНАЛ
# ║ CallerID: 101
# ║ Exten: 102
# ╚══════════════════════════════════════
#
# ⚠️  РЕЖИМ ОТЛАДКИ: Используем тестовый номер 79991234567
# 📞 Обработка звонка: 79991234567
# ✓ Контакт найден: ID=12345
# ✓ Звонок добавлен к контакту
```

**Что происходит:**
- Asterisk видит внутренний звонок 101→102
- Скрипт понимает, что это внутренний (короткий номер)
- В режиме отладки подменяет на `test_phone`
- Создаёт событие для тестового контакта в AmoCRM

---

### 🎯 Метод 3: Webhook (БЕЗ ASTERISK)

Отправьте POST запрос напрямую:

```bash
curl -X POST http://localhost:8080/webhook/call \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "79991234567",
    "direction": "inbound",
    "duration": 65,
    "status": "ANSWERED",
    "uniqueid": "manual_test_123"
  }'
```

**Проверка в AmoCRM:**
- Контакт → вкладка "События"
- Должен появиться входящий звонок длительностью 65 сек

---

### 🎯 Метод 4: Реальный внешний звонок

**Входящий:**
```bash
# Позвоните на номер вашей АТС с мобильного
# Номер должен быть в AmoCRM как контакт
```

**Исходящий:**
```bash
# С внутреннего номера позвоните на внешний
# Наберите: 89991234567 (если номер есть в AmoCRM)
```

**В логах увидите:**
```
╔══════════════════════════════════════
║ НОВЫЙ КАНАЛ
║ Channel: PJSIP/trunk-00000123
║ CallerID: 79991234567
║ Context: from-trunk
║ Direction: inbound
╚══════════════════════════════════════

✓ Контакт найден: ID=12345, Имя=Иван Иванов
✓ Звонок добавлен к контакту 12345
```

---

## 📊 Что смотреть в логах

### Успешная обработка:

```
2025-10-17 16:30:00 - INFO - ╔══════════════════════════════════════
2025-10-17 16:30:00 - INFO - ║ НОВЫЙ КАНАЛ
2025-10-17 16:30:00 - INFO - ║ CallerID:  79991234567
2025-10-17 16:30:30 - INFO - ╔══════════════════════════════════════
2025-10-17 16:30:30 - INFO - ║ ЗАВЕРШЕНИЕ ЗВОНКА
2025-10-17 16:30:30 - INFO - ║ Duration:   30s
2025-10-17 16:30:30 - INFO - ✓ Звонок отправлен на обработку
2025-10-17 16:30:31 - INFO - 📞 Обработка звонка: 79991234567
2025-10-17 16:30:31 - INFO - ✓ Контакт найден: ID=12345
2025-10-17 16:30:32 - INFO - ✓ Звонок добавлен к контакту 12345
```

### Контакт не найден:

```
2025-10-17 16:30:31 - INFO - ❌ Контакт не найден для 79998887766
2025-10-17 16:30:31 - INFO - ✓ Неразобранное создано
```

### Ошибки:

```
2025-10-17 16:30:31 - ERROR - API error 401: Unauthorized
2025-10-17 16:30:31 - INFO - Токены обновлены
```

---

## 🔍 Проверка в AmoCRM

### 1. Через контакт:
1. Откройте AmoCRM
2. Найдите контакт по номеру
3. Вкладка **"События"**
4. Должны быть записи звонков с:
   - ✅ Направлением (входящий/исходящий)
   - ✅ Длительностью
   - ✅ Временем

### 2. Через неразобранные:
1. AmoCRM → **"Неразобранное"**
2. Если номер не был в базе - появится новая заявка

### 3. Запись разговора:
1. Контакт → вкладка **"Файлы"**
2. Должен быть WAV/MP3 файл записи

---

## ❌ Troubleshooting

### Проблема: "Не удалось извлечь номер"

**Причина:** Внутренний звонок без режима отладки

**Решение:**
```json
{
  "debug": {
    "process_internal_calls": true,
    "test_phone": "79991234567"
  }
}
```

### Проблема: "Контакт не найден"

**Причина:** Номера в AmoCRM в другом формате

**Проверка:**
```bash
# Посмотрите как хранится номер
curl http://localhost:8080/test-call

# В логах увидите какой формат ищется
```

**Решение:** Приведите номера в AmoCRM к формату `79991234567` (без +, пробелов, дефисов)

### Проблема: "API error 401"

**Причина:** Токены устарели

**Решение:**
```bash
# Автоматически обновятся
# Или удалите и получите заново:
rm /opt/freepbx-amocrm/tokens.json
systemctl restart freepbx-amocrm
```

### Проблема: События не ловятся

**Проверка AMI:**
```bash
# 1. Проверьте что AMI работает
asterisk -rx "manager show users"

# 2. Проверьте события в реальном времени
asterisk -rx "manager show events"

# 3. Попробуйте подключиться
telnet localhost 5038
```

**Решение:**
```bash
# Перезагрузите Asterisk
asterisk -rx "core restart now"

# Перезапустите интеграцию
systemctl restart freepbx-amocrm
```

---

## 🎬 Финальная проверка

### Чеклист перед продакшеном:

- [ ] ✅ Тестовый endpoint работает
- [ ] ✅ Внутренний звонок обрабатывается (с отладкой)
- [ ] ✅ Внешний входящий создаёт событие
- [ ] ✅ Внешний исходящий создаёт событие
- [ ] ✅ Записи загружаются
- [ ] ✅ Неразобранные создаются для новых номеров
- [ ] 🔴 **ОТКЛЮЧИТЬ** `process_internal_calls` для продакшена!

### Отключение режима отладки:

```json
{
  "debug": {
    "process_internal_calls": false,
    "detailed_ami_logging": false
  }
}
```

```bash
systemctl restart freepbx-amocrm
```

---

## 📈 Мониторинг в продакшене

```bash
# Статистика за сегодня
journalctl -u freepbx-amocrm --since today | grep "✓ Звонок добавлен"

# Ошибки
journalctl -u freepbx-amocrm --since today -p err

# Живые логи
journalctl -u freepbx-amocrm -f | grep -E "📞|✓|❌"
```