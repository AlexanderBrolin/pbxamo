# ๐งช ะัะบะพะฒะพะดััะฒะพ ะฟะพ ัะตััะธัะพะฒะฐะฝะธั ะธะฝัะตะณัะฐัะธะธ FreePBX 17 + AmoCRM

## ะะพะดะณะพัะพะฒะบะฐ ะบ ัะตััะธัะพะฒะฐะฝะธั

### 1. ะะบะปััะธัะต ัะตะถะธะผ ะพัะปะฐะดะบะธ

ะััะตะดะฐะบัะธััะนัะต `/opt/freepbx-amocrm/config.json`:

```json
{
  "debug": {
    "process_internal_calls": true,
    "test_phone": "79991234567",
    "detailed_ami_logging": true
  }
}
```

**ะะดะต:**
- `process_internal_calls: true` - ะพะฑัะฐะฑะฐััะฒะฐัั ะฒะฝัััะตะฝะฝะธะต ะทะฒะพะฝะบะธ (101โ102)
- `test_phone` - ัะตะฐะปัะฝัะน ะฝะพะผะตั ะธะท AmoCRM ะดะปั ัะตััะธัะพะฒะฐะฝะธั
- `detailed_ami_logging: true` - ะฟะพะดัะพะฑะฝัะต ะปะพะณะธ ัะพะฑััะธะน AMI

ะะตัะตะทะฐะฟัััะธัะต ัะตัะฒะธั:
```bash
systemctl restart freepbx-amocrm
```

### 2. ะะพะฑะฐะฒััะต ัะตััะพะฒัะน ะบะพะฝัะฐะบั ะฒ AmoCRM

1. ะะฐะนะดะธัะต ะฒ AmoCRM
2. ะกะพะทะดะฐะนัะต ะบะพะฝัะฐะบั ั ะฝะพะผะตัะพะผ `+7 999 123-45-67`
3. ะกะพััะฐะฝะธัะต

## ะะตัะพะดั ัะตััะธัะพะฒะฐะฝะธั

### ๐ฏ ะะตัะพะด 1: ะขะตััะพะฒัะน endpoint (ะกะะะซะ ะะะะกะขะะ)

ะัะฟะพะปัะทัะนัะต ะฒัััะพะตะฝะฝัะน ัะตััะพะฒัะน endpoint:

```bash
# ะัะฟัะฐะฒะปัะตะผ ัะตััะพะฒัะน ะทะฒะพะฝะพะบ
curl http://localhost:8080/test-call

# ะะถะธะดะฐะตะผัะน ะพัะฒะตั:
{
  "success": true,
  "message": "ะขะตััะพะฒัะน ะทะฒะพะฝะพะบ ะพะฑัะฐะฑะพัะฐะฝ ะดะปั ะฝะพะผะตัะฐ 79991234567",
  "call_data": {
    "phone": "79991234567",
    "direction": "inbound",
    "duration": 42,
    "status": "ANSWERED"
  }
}
```

**ะัะพะฒะตัะบะฐ:**
1. ะะพัะผะพััะธัะต ะปะพะณะธ: `journalctl -u freepbx-amocrm -n 50`
2. ะะฐะนะดะธัะต ะฒ AmoCRM โ ะฝะฐะนะดะธัะต ะบะพะฝัะฐะบั โ ะดะพะปะถะตะฝ ะฟะพัะฒะธัััั ะทะฒะพะฝะพะบ

---

### ๐ฏ ะะตัะพะด 2: ะะฝัััะตะฝะฝะธะน ะทะฒะพะฝะพะบ (ะก ะะขะะะะะะ)

ะัะธ ะฒะบะปััะตะฝะฝะพะผ `process_internal_calls: true`:

```bash
# 1. ะกะปะตะดะธัะต ะทะฐ ะปะพะณะฐะผะธ
journalctl -u freepbx-amocrm -f

# 2. ะกะดะตะปะฐะนัะต ะฒะฝัััะตะฝะฝะธะน ะทะฒะพะฝะพะบ
# ะก ัะตะปะตัะพะฝะฐ 101 ะฟะพะทะฒะพะฝะธัะต ะฝะฐ 102
# ะะพะณะพะฒะพัะธัะต ~30 ัะตะบัะฝะด
# ะะพะปะพะถะธัะต ัััะฑะบั

# 3. ะ ะปะพะณะฐั ัะฒะธะดะธัะต:
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ะะะะซะ ะะะะะ
# โ CallerID: 101
# โ Exten: 102
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
#
# โ๏ธ  ะะะะะ ะะขะะะะะ: ะัะฟะพะปัะทัะตะผ ัะตััะพะฒัะน ะฝะพะผะตั 79991234567
# ๐ ะะฑัะฐะฑะพัะบะฐ ะทะฒะพะฝะบะฐ: 79991234567
# โ ะะพะฝัะฐะบั ะฝะฐะนะดะตะฝ: ID=12345
# โ ะะฒะพะฝะพะบ ะดะพะฑะฐะฒะปะตะฝ ะบ ะบะพะฝัะฐะบัั
```

**ะงัะพ ะฟัะพะธััะพะดะธั:**
- Asterisk ะฒะธะดะธั ะฒะฝัััะตะฝะฝะธะน ะทะฒะพะฝะพะบ 101โ102
- ะกะบัะธะฟั ะฟะพะฝะธะผะฐะตั, ััะพ ััะพ ะฒะฝัััะตะฝะฝะธะน (ะบะพัะพัะบะธะน ะฝะพะผะตั)
- ะ ัะตะถะธะผะต ะพัะปะฐะดะบะธ ะฟะพะดะผะตะฝัะตั ะฝะฐ `test_phone`
- ะกะพะทะดะฐัั ัะพะฑััะธะต ะดะปั ัะตััะพะฒะพะณะพ ะบะพะฝัะฐะบัะฐ ะฒ AmoCRM

---

### ๐ฏ ะะตัะพะด 3: Webhook (ะะะ ASTERISK)

ะัะฟัะฐะฒััะต POST ะทะฐะฟัะพั ะฝะฐะฟััะผัั:

```bash
curl -X POST http://localhost:8080/webhook/call \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "79991234567",
    "direction": "inbound",
    "duration": 65,
    "status": "ANSWERED",
    "uniqueid": "manual_test_123"
  }'
```

**ะัะพะฒะตัะบะฐ ะฒ AmoCRM:**
- ะะพะฝัะฐะบั โ ะฒะบะปะฐะดะบะฐ "ะกะพะฑััะธั"
- ะะพะปะถะตะฝ ะฟะพัะฒะธัััั ะฒัะพะดััะธะน ะทะฒะพะฝะพะบ ะดะปะธัะตะปัะฝะพัััั 65 ัะตะบ

---

### ๐ฏ ะะตัะพะด 4: ะะตะฐะปัะฝัะน ะฒะฝะตัะฝะธะน ะทะฒะพะฝะพะบ

**ะัะพะดััะธะน:**
```bash
# ะะพะทะฒะพะฝะธัะต ะฝะฐ ะฝะพะผะตั ะฒะฐัะตะน ะะขะก ั ะผะพะฑะธะปัะฝะพะณะพ
# ะะพะผะตั ะดะพะปะถะตะฝ ะฑััั ะฒ AmoCRM ะบะฐะบ ะบะพะฝัะฐะบั
```

**ะััะพะดััะธะน:**
```bash
# ะก ะฒะฝัััะตะฝะฝะตะณะพ ะฝะพะผะตัะฐ ะฟะพะทะฒะพะฝะธัะต ะฝะฐ ะฒะฝะตัะฝะธะน
# ะะฐะฑะตัะธัะต: 89991234567 (ะตัะปะธ ะฝะพะผะตั ะตััั ะฒ AmoCRM)
```

**ะ ะปะพะณะฐั ัะฒะธะดะธัะต:**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะะะะซะ ะะะะะ
โ Channel: PJSIP/trunk-00000123
โ CallerID: 79991234567
โ Context: from-trunk
โ Direction: inbound
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ะะพะฝัะฐะบั ะฝะฐะนะดะตะฝ: ID=12345, ะะผั=ะะฒะฐะฝ ะะฒะฐะฝะพะฒ
โ ะะฒะพะฝะพะบ ะดะพะฑะฐะฒะปะตะฝ ะบ ะบะพะฝัะฐะบัั 12345
```

---

## ๐ ะงัะพ ัะผะพััะตัั ะฒ ะปะพะณะฐั

### ะฃัะฟะตัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ:

```
2025-10-17 16:30:00 - INFO - โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
2025-10-17 16:30:00 - INFO - โ ะะะะซะ ะะะะะ
2025-10-17 16:30:00 - INFO - โ CallerID:  79991234567
2025-10-17 16:30:30 - INFO - โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
2025-10-17 16:30:30 - INFO - โ ะะะะะะจะะะะ ะะะะะะ
2025-10-17 16:30:30 - INFO - โ Duration:   30s
2025-10-17 16:30:30 - INFO - โ ะะฒะพะฝะพะบ ะพัะฟัะฐะฒะปะตะฝ ะฝะฐ ะพะฑัะฐะฑะพัะบั
2025-10-17 16:30:31 - INFO - ๐ ะะฑัะฐะฑะพัะบะฐ ะทะฒะพะฝะบะฐ: 79991234567
2025-10-17 16:30:31 - INFO - โ ะะพะฝัะฐะบั ะฝะฐะนะดะตะฝ: ID=12345
2025-10-17 16:30:32 - INFO - โ ะะฒะพะฝะพะบ ะดะพะฑะฐะฒะปะตะฝ ะบ ะบะพะฝัะฐะบัั 12345
```

### ะะพะฝัะฐะบั ะฝะต ะฝะฐะนะดะตะฝ:

```
2025-10-17 16:30:31 - INFO - โ ะะพะฝัะฐะบั ะฝะต ะฝะฐะนะดะตะฝ ะดะปั 79998887766
2025-10-17 16:30:31 - INFO - โ ะะตัะฐะทะพะฑัะฐะฝะฝะพะต ัะพะทะดะฐะฝะพ
```

### ะัะธะฑะบะธ:

```
2025-10-17 16:30:31 - ERROR - API error 401: Unauthorized
2025-10-17 16:30:31 - INFO - ะขะพะบะตะฝั ะพะฑะฝะพะฒะปะตะฝั
```

---

## ๐ ะัะพะฒะตัะบะฐ ะฒ AmoCRM

### 1. ะงะตัะตะท ะบะพะฝัะฐะบั:
1. ะัะบัะพะนัะต AmoCRM
2. ะะฐะนะดะธัะต ะบะพะฝัะฐะบั ะฟะพ ะฝะพะผะตัั
3. ะะบะปะฐะดะบะฐ **"ะกะพะฑััะธั"**
4. ะะพะปะถะฝั ะฑััั ะทะฐะฟะธัะธ ะทะฒะพะฝะบะพะฒ ั:
   - โ ะะฐะฟัะฐะฒะปะตะฝะธะตะผ (ะฒัะพะดััะธะน/ะธััะพะดััะธะน)
   - โ ะะปะธัะตะปัะฝะพัััั
   - โ ะัะตะผะตะฝะตะผ

### 2. ะงะตัะตะท ะฝะตัะฐะทะพะฑัะฐะฝะฝัะต:
1. AmoCRM โ **"ะะตัะฐะทะพะฑัะฐะฝะฝะพะต"**
2. ะัะปะธ ะฝะพะผะตั ะฝะต ะฑัะป ะฒ ะฑะฐะทะต - ะฟะพัะฒะธััั ะฝะพะฒะฐั ะทะฐัะฒะบะฐ

### 3. ะะฐะฟะธัั ัะฐะทะณะพะฒะพัะฐ:
1. ะะพะฝัะฐะบั โ ะฒะบะปะฐะดะบะฐ **"ะคะฐะนะปั"**
2. ะะพะปะถะตะฝ ะฑััั WAV/MP3 ัะฐะนะป ะทะฐะฟะธัะธ

---

## โ Troubleshooting

### ะัะพะฑะปะตะผะฐ: "ะะต ัะดะฐะปะพัั ะธะทะฒะปะตัั ะฝะพะผะตั"

**ะัะธัะธะฝะฐ:** ะะฝัััะตะฝะฝะธะน ะทะฒะพะฝะพะบ ะฑะตะท ัะตะถะธะผะฐ ะพัะปะฐะดะบะธ

**ะะตัะตะฝะธะต:**
```json
{
  "debug": {
    "process_internal_calls": true,
    "test_phone": "79991234567"
  }
}
```

### ะัะพะฑะปะตะผะฐ: "ะะพะฝัะฐะบั ะฝะต ะฝะฐะนะดะตะฝ"

**ะัะธัะธะฝะฐ:** ะะพะผะตัะฐ ะฒ AmoCRM ะฒ ะดััะณะพะผ ัะพัะผะฐัะต

**ะัะพะฒะตัะบะฐ:**
```bash
# ะะพัะผะพััะธัะต ะบะฐะบ ััะฐะฝะธััั ะฝะพะผะตั
curl http://localhost:8080/test-call

# ะ ะปะพะณะฐั ัะฒะธะดะธัะต ะบะฐะบะพะน ัะพัะผะฐั ะธัะตััั
```

**ะะตัะตะฝะธะต:** ะัะธะฒะตะดะธัะต ะฝะพะผะตัะฐ ะฒ AmoCRM ะบ ัะพัะผะฐัั `79991234567` (ะฑะตะท +, ะฟัะพะฑะตะปะพะฒ, ะดะตัะธัะพะฒ)

### ะัะพะฑะปะตะผะฐ: "API error 401"

**ะัะธัะธะฝะฐ:** ะขะพะบะตะฝั ัััะฐัะตะปะธ

**ะะตัะตะฝะธะต:**
```bash
# ะะฒัะพะผะฐัะธัะตัะบะธ ะพะฑะฝะพะฒัััั
# ะะปะธ ัะดะฐะปะธัะต ะธ ะฟะพะปััะธัะต ะทะฐะฝะพะฒะพ:
rm /opt/freepbx-amocrm/tokens.json
systemctl restart freepbx-amocrm
```

### ะัะพะฑะปะตะผะฐ: ะกะพะฑััะธั ะฝะต ะปะพะฒัััั

**ะัะพะฒะตัะบะฐ AMI:**
```bash
# 1. ะัะพะฒะตัััะต ััะพ AMI ัะฐะฑะพัะฐะตั
asterisk -rx "manager show users"

# 2. ะัะพะฒะตัััะต ัะพะฑััะธั ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
asterisk -rx "manager show events"

# 3. ะะพะฟัะพะฑัะนัะต ะฟะพะดะบะปััะธัััั
telnet localhost 5038
```

**ะะตัะตะฝะธะต:**
```bash
# ะะตัะตะทะฐะณััะทะธัะต Asterisk
asterisk -rx "core restart now"

# ะะตัะตะทะฐะฟัััะธัะต ะธะฝัะตะณัะฐัะธั
systemctl restart freepbx-amocrm
```

---

## ๐ฌ ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ

### ะงะตะบะปะธัั ะฟะตัะตะด ะฟัะพะดะฐะบัะตะฝะพะผ:

- [ ] โ ะขะตััะพะฒัะน endpoint ัะฐะฑะพัะฐะตั
- [ ] โ ะะฝัััะตะฝะฝะธะน ะทะฒะพะฝะพะบ ะพะฑัะฐะฑะฐััะฒะฐะตััั (ั ะพัะปะฐะดะบะพะน)
- [ ] โ ะะฝะตัะฝะธะน ะฒัะพะดััะธะน ัะพะทะดะฐัั ัะพะฑััะธะต
- [ ] โ ะะฝะตัะฝะธะน ะธััะพะดััะธะน ัะพะทะดะฐัั ัะพะฑััะธะต
- [ ] โ ะะฐะฟะธัะธ ะทะฐะณััะถะฐัััั
- [ ] โ ะะตัะฐะทะพะฑัะฐะฝะฝัะต ัะพะทะดะฐัััั ะดะปั ะฝะพะฒัั ะฝะพะผะตัะพะฒ
- [ ] ๐ด **ะะขะะะฎะงะะขะฌ** `process_internal_calls` ะดะปั ะฟัะพะดะฐะบัะตะฝะฐ!

### ะัะบะปััะตะฝะธะต ัะตะถะธะผะฐ ะพัะปะฐะดะบะธ:

```json
{
  "debug": {
    "process_internal_calls": false,
    "detailed_ami_logging": false
  }
}
```

```bash
systemctl restart freepbx-amocrm
```

---

## ๐ ะะพะฝะธัะพัะธะฝะณ ะฒ ะฟัะพะดะฐะบัะตะฝะต

```bash
# ะกัะฐัะธััะธะบะฐ ะทะฐ ัะตะณะพะดะฝั
journalctl -u freepbx-amocrm --since today | grep "โ ะะฒะพะฝะพะบ ะดะพะฑะฐะฒะปะตะฝ"

# ะัะธะฑะบะธ
journalctl -u freepbx-amocrm --since today -p err

# ะะธะฒัะต ะปะพะณะธ
journalctl -u freepbx-amocrm -f | grep -E "๐|โ|โ"
```